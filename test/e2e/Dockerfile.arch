# ════════════════════════════════════════════════════════════════════════════════
# Arch Linux E2E Test Environment
# ════════════════════════════════════════════════════════════════════════════════
# Uses Arch Linux for the absolute latest packages including Neovim 0.10+

FROM archlinux:latest

# Environment setup
ENV LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8 \
    TZ=UTC

# Update system and install packages
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
    # Essential tools
    base-devel \
    git \
    curl \
    wget \
    sudo \
    which \
    # Development tools
    cmake \
    python \
    python-pip \
    nodejs \
    npm \
    # Shell and terminal
    zsh \
    tmux \
    # Neovim (latest version, usually 0.10+)
    neovim \
    # Additional tools
    ripgrep \
    fd \
    fzf \
    bat \
    jq \
    tree \
    htop \
    unzip \
    # Locale
    glibc \
    && pacman -Scc --noconfirm

# Generate locale
RUN echo "en_US.UTF-8 UTF-8" > /etc/locale.gen && \
    locale-gen

# Install Python packages for Neovim
RUN pip install --break-system-packages \
    pynvim \
    neovim \
    pyright \
    ruff \
    black \
    isort \
    yapf

# Install Node.js packages
RUN npm install -g \
    typescript \
    typescript-language-server \
    prettier \
    eslint \
    @fsouza/prettierd

# Create test user with sudo privileges
RUN useradd -m -s /bin/zsh testuser && \
    echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers && \
    mkdir -p /home/testuser/.local/share && \
    mkdir -p /home/testuser/.cache && \
    mkdir -p /home/testuser/.config && \
    chown -R testuser:testuser /home/testuser

# Switch to test user
USER testuser
WORKDIR /home/testuser

# Pre-create directories that setup will need
RUN mkdir -p \
    ~/.local/bin \
    ~/.local/share/nvim \
    ~/.config/nvim \
    ~/.cache/nvim \
    ~/.local/state/nvim

# Set PATH
ENV PATH="/home/testuser/.local/bin:/home/testuser/bin:${PATH}"

# Default command
CMD ["/bin/bash"]