# ════════════════════════════════════════════════════════════════════════════════
# Ubuntu 24.04 E2E Test Environment
# ════════════════════════════════════════════════════════════════════════════════
# Ubuntu 24.04 includes Neovim 0.9.5 in official repos

FROM ubuntu:24.04

# Environment setup
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8 \
    TZ=UTC

# Install system dependencies required for setup script
RUN apt-get update && apt-get install -y \
    # Essential tools
    curl \
    wget \
    git \
    sudo \
    # Build tools
    build-essential \
    cmake \
    pkg-config \
    autoconf \
    automake \
    libtool \
    # Development tools
    python3 \
    python3-pip \
    python3-venv \
    nodejs \
    npm \
    # Shell and terminal
    zsh \
    tmux \
    # System utilities
    locales \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    # Libraries for Neovim
    gettext \
    libtool-bin \
    unzip \
    # Additional tools
    ripgrep \
    fd-find \
    fzf \
    bat \
    jq \
    tree \
    htop \
    && rm -rf /var/lib/apt/lists/*

# Install Neovim 0.10+ from official PPA
RUN add-apt-repository ppa:neovim-ppa/unstable -y && \
    apt-get update && \
    apt-get install -y neovim && \
    rm -rf /var/lib/apt/lists/*

# Generate locale
RUN locale-gen en_US.UTF-8 && update-locale LANG=en_US.UTF-8

# Install language servers for testing (--break-system-packages for PEP 668)
RUN pip3 install --break-system-packages --no-cache-dir \
    pynvim \
    neovim \
    pyright \
    ruff \
    black \
    isort \
    yapf

# Install Node.js packages
RUN npm install -g \
    typescript \
    typescript-language-server \
    prettier \
    eslint \
    @fsouza/prettierd

# Create test user with sudo privileges
RUN useradd -m -s /bin/zsh testuser && \
    usermod -aG sudo testuser && \
    echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers && \
    mkdir -p /home/testuser/.local/share && \
    mkdir -p /home/testuser/.cache && \
    mkdir -p /home/testuser/.config && \
    chown -R testuser:testuser /home/testuser

# Switch to test user
USER testuser
WORKDIR /home/testuser

# Pre-create directories that setup will need
RUN mkdir -p \
    ~/.local/bin \
    ~/.local/share/nvim \
    ~/.config/nvim \
    ~/.cache/nvim \
    ~/.local/state/nvim

# Set PATH
ENV PATH="/home/testuser/.local/bin:/home/testuser/bin:${PATH}"

# Copy dotfiles repository
COPY --chown=testuser:testuser . /home/testuser/.dotfiles

# Set environment variables
ENV HOME=/home/testuser
ENV DOTFILES_DIR=/home/testuser/.dotfiles
ENV SHELL=/bin/zsh

# Default command
CMD ["/bin/bash"]