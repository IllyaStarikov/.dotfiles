version: '3.8'

# ════════════════════════════════════════════════════════════════════════════════
# End-to-End Test Docker Compose Configuration
# ════════════════════════════════════════════════════════════════════════════════
#
# This configuration provides comprehensive E2E testing across multiple platforms
#
# Usage:
#   docker-compose -f test/e2e/docker-compose.yml up ubuntu-e2e
#   docker-compose -f test/e2e/docker-compose.yml up --abort-on-container-exit
#
# ════════════════════════════════════════════════════════════════════════════════

services:
  # ──────────────────────────────────────────────────────────────────────────────
  # Ubuntu 22.04 LTS - Primary test platform
  # ──────────────────────────────────────────────────────────────────────────────
  ubuntu-e2e:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.ubuntu
      args:
        - UBUNTU_VERSION=22.04
    container_name: dotfiles-ubuntu-e2e
    hostname: ubuntu-test
    environment:
      - CI=true
      - E2E_TEST=true
      - TERM=xterm-256color
      - DEBIAN_FRONTEND=noninteractive
    volumes:
      - ../../:/home/testuser/.dotfiles:ro
      - test-cache-ubuntu:/home/testuser/.cache
      - test-local-ubuntu:/home/testuser/.local
      - test-config-ubuntu:/home/testuser/.config
    tmpfs:
      - /tmp
    command: |
      -c "
        cd /home/testuser/.dotfiles &&
        chmod +x test/e2e/docker-e2e-test.zsh &&
        zsh test/e2e/docker-e2e-test.zsh
      "
    networks:
      - test-network

  # ──────────────────────────────────────────────────────────────────────────────
  # Fedora 39 - RPM-based testing
  # ──────────────────────────────────────────────────────────────────────────────
  fedora-e2e:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.fedora
    container_name: dotfiles-fedora-e2e
    hostname: fedora-test
    environment:
      - CI=true
      - E2E_TEST=true
      - TERM=xterm-256color
    volumes:
      - ../../:/home/testuser/.dotfiles:ro
      - test-cache-fedora:/home/testuser/.cache
      - test-local-fedora:/home/testuser/.local
      - test-config-fedora:/home/testuser/.config
    tmpfs:
      - /tmp
    command: |
      -c "
        cd /home/testuser/.dotfiles &&
        chmod +x test/e2e/docker-e2e-test.zsh &&
        zsh test/e2e/docker-e2e-test.zsh
      "
    networks:
      - test-network

  # ──────────────────────────────────────────────────────────────────────────────
  # Arch Linux - Rolling release testing
  # ──────────────────────────────────────────────────────────────────────────────
  arch-e2e:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.arch
    container_name: dotfiles-arch-e2e
    hostname: arch-test
    environment:
      - CI=true
      - E2E_TEST=true
      - TERM=xterm-256color
    volumes:
      - ../../:/home/testuser/.dotfiles:ro
      - test-cache-arch:/home/testuser/.cache
      - test-local-arch:/home/testuser/.local
      - test-config-arch:/home/testuser/.config
    tmpfs:
      - /tmp
    command: |
      -c "
        cd /home/testuser/.dotfiles &&
        chmod +x test/e2e/docker-e2e-test.zsh &&
        zsh test/e2e/docker-e2e-test.zsh
      "
    networks:
      - test-network

  # ──────────────────────────────────────────────────────────────────────────────
  # All platforms parallel test
  # ──────────────────────────────────────────────────────────────────────────────
  all-e2e:
    image: alpine:latest
    container_name: dotfiles-orchestrator
    depends_on:
      - ubuntu-e2e
      - fedora-e2e
      - arch-e2e
    command: echo "All E2E tests started"
    networks:
      - test-network

  # ──────────────────────────────────────────────────────────────────────────────
  # Interactive debugging container
  # ──────────────────────────────────────────────────────────────────────────────
  debug-e2e:
    build:
      context: ../..
      dockerfile: test/e2e/Dockerfile.ubuntu
      args:
        - UBUNTU_VERSION=22.04
    container_name: dotfiles-debug-e2e
    hostname: debug-test
    environment:
      - CI=false
      - DEBUG=true
      - TERM=xterm-256color
    volumes:
      - ../../:/home/testuser/.dotfiles:ro
      - test-cache-debug:/home/testuser/.cache
      - test-local-debug:/home/testuser/.local
      - test-config-debug:/home/testuser/.config
    stdin_open: true
    tty: true
    command: /bin/bash
    networks:
      - test-network

# ──────────────────────────────────────────────────────────────────────────────
# Volumes for persistent data between runs
# ──────────────────────────────────────────────────────────────────────────────
volumes:
  test-cache-ubuntu:
  test-local-ubuntu:
  test-config-ubuntu:
  test-cache-fedora:
  test-local-fedora:
  test-config-fedora:
  test-cache-arch:
  test-local-arch:
  test-config-arch:
  test-cache-debug:
  test-local-debug:
  test-config-debug:

# ──────────────────────────────────────────────────────────────────────────────
# Network for inter-container communication
# ──────────────────────────────────────────────────────────────────────────────
networks:
  test-network:
    driver: bridge