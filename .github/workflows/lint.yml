name: lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: lint-${{ github.ref }}
  cancel-in-progress: true

jobs:
  zsh:
    name: zsh syntax
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: install zsh
        run: sudo apt-get update -qq && sudo apt-get install -y zsh

      - name: validate zsh syntax
        run: |
          echo "::group::Checking Zsh syntax"
          errors=0

          # Check .zsh files
          while IFS= read -r -d '' file; do
            if ! zsh -n "$file" 2>/dev/null; then
              echo "❌ Syntax error: $file"
              errors=$((errors + 1))
            fi
          done < <(find src test -name "*.zsh" -type f -print0 2>/dev/null)

          # Check scripts with zsh shebang
          while IFS= read -r file; do
            if ! zsh -n "$file" 2>/dev/null; then
              echo "❌ Syntax error: $file"
              errors=$((errors + 1))
            fi
          done < <(grep -rl '^#!/usr/bin/env zsh' src/scripts 2>/dev/null || true)

          echo "::endgroup::"

          if [[ $errors -gt 0 ]]; then
            echo "❌ Found $errors Zsh syntax errors"
            exit 1
          fi
          echo "✅ All Zsh files pass syntax validation"

  lua:
    name: lua files
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: install lua
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y lua5.4

      - name: validate lua syntax
        run: |
          echo "::group::Checking Lua syntax"
          errors=0

          while IFS= read -r -d '' file; do
            if ! luac -p "$file" 2>/dev/null; then
              echo "❌ Syntax error: $file"
              errors=$((errors + 1))
            fi
          done < <(find src/neovim src/wezterm -name "*.lua" -type f -print0 2>/dev/null)

          echo "::endgroup::"

          if [[ $errors -gt 0 ]]; then
            echo "❌ Found $errors Lua syntax errors"
            exit 1
          fi
          echo "✅ All Lua files pass syntax validation"

      - name: cache stylua
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/stylua
          key: ${{ runner.os }}-stylua-v0.19.1

      - name: check lua formatting
        run: |
          # Install stylua if not cached
          if ! command -v stylua &> /dev/null; then
            wget -qO stylua.zip https://github.com/JohnnyMorganz/StyLua/releases/download/v0.19.1/stylua-linux-x86_64.zip
            unzip -q stylua.zip && chmod +x stylua && sudo mv stylua /usr/local/bin/
          fi

          echo "::group::Checking Lua formatting"
          stylua --check src/neovim src/wezterm --config-path src/language/stylua.toml
          echo "::endgroup::"
          echo "✅ All Lua files are properly formatted"

  python:
    name: python files
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: install ruff
        run: pip install ruff

      - name: lint python
        run: |
          echo "::group::Checking Python linting"
          ruff check src/cortex --config src/language/ruff.toml
          echo "::endgroup::"
          echo "✅ All Python files pass linting"

      - name: check python formatting
        run: |
          echo "::group::Checking Python formatting"
          ruff format --check src/cortex --config src/language/ruff.toml
          echo "::endgroup::"
          echo "✅ All Python files are properly formatted"

  toml:
    name: toml files
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: cache taplo
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/taplo
          key: ${{ runner.os }}-taplo-v0.9.0-2

      - name: validate toml
        continue-on-error: true
        run: |
          # Install taplo if not cached
          if ! command -v taplo &> /dev/null; then
            echo "Installing taplo..."
            curl -fsSL -o taplo.gz https://github.com/tamasfe/taplo/releases/download/0.9.0/taplo-full-linux-x86_64.gz || {
              echo "⚠️ Failed to download taplo, skipping TOML validation"
              exit 0
            }
            gunzip taplo.gz && chmod +x taplo && sudo mv taplo /usr/local/bin/
          fi

          echo "::group::Checking TOML files"
          errors=0
          while IFS= read -r file; do
            echo "Validating: $file"
            if ! taplo format --check "$file" 2>/dev/null; then
              errors=$((errors + 1))
            fi
          done < <(find . -name "*.toml" -type f -not -path "./.git/*" -not -path "./styleguide/*")
          echo "::endgroup::"

          if [[ $errors -gt 0 ]]; then
            echo "⚠️ Found $errors TOML formatting issues (non-blocking)"
          else
            echo "✅ All TOML files are valid"
          fi

  markdown:
    name: markdown
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: lint markdown
        run: |
          npm install -g markdownlint-cli --silent

          echo "::group::Checking markdown files"
          markdownlint '**/*.md' --ignore node_modules --ignore .github --ignore styleguide || true
          echo "::endgroup::"

  yaml:
    name: yaml files
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: validate yaml
        run: |
          npm install -g yaml-lint --silent

          echo "::group::Checking YAML files"
          errors=0
          while IFS= read -r file; do
            echo "Checking: $file"
            if ! yaml-lint "$file" 2>/dev/null; then
              errors=$((errors + 1))
            fi
          done < <(find . \( -name "*.yml" -o -name "*.yaml" \) -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./styleguide/*")

          echo "::endgroup::"

          if [[ $errors -gt 0 ]]; then
            echo "⚠️ Found $errors YAML validation warnings (non-blocking)"
          else
            echo "✅ All YAML files are valid"
          fi

  json:
    name: json files
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: validate json
        run: |
          echo "::group::Checking JSON files"
          errors=0
          while IFS= read -r file; do
            echo "Checking: $file"
            if ! jq . "$file" > /dev/null 2>&1; then
              echo "❌ Invalid JSON: $file"
              errors=$((errors + 1))
            fi
          done < <(find . -name "*.json" -type f -not -path "./.git/*" -not -path "./styleguide/*")

          echo "::endgroup::"

          if [[ $errors -gt 0 ]]; then
            echo "❌ Found $errors invalid JSON files"
            exit 1
          fi
          echo "✅ All JSON files are valid"

  code-quality:
    name: code quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: check code quality
        run: |
          echo "::group::Checking for code quality issues"
          errors=0

          # Check for trailing whitespace
          echo "Checking for trailing whitespace..."
          if grep -r '[[:space:]]$' src/ test/ --include="*.sh" --include="*.lua" --include="*.py" --include="*.zsh" 2>/dev/null; then
            echo "⚠️ Trailing whitespace found"
            errors=$((errors + 1))
          fi

          # Check for tabs in space-only files
          echo "Checking for tabs in space-only files..."
          if grep -r $'\t' src/ --include="*.lua" --include="*.yml" --include="*.yaml" --include="*.json" 2>/dev/null; then
            echo "⚠️ Tabs found in space-only files"
            errors=$((errors + 1))
          fi

          # Check for CRLF line endings
          echo "Checking for Windows line endings..."
          if find src/ test/ -type f -exec file {} \; 2>/dev/null | grep -q CRLF; then
            echo "⚠️ Windows line endings found"
            errors=$((errors + 1))
          fi

          # Check for large files
          echo "Checking for large files..."
          find . -type f -size +1M -not -path "./.git/*" -exec ls -lh {} \; | awk '{print "⚠️ Large file:", $9, "(" $5 ")"}'

          echo "::endgroup::"

          if [[ $errors -gt 0 ]]; then
            echo "⚠️ Found $errors code quality issues (non-blocking)"
          else
            echo "✅ No code quality issues found"
          fi

  lint-status:
    name: lint status
    if: always()
    needs: [zsh, lua, python, toml, markdown, yaml, json, code-quality]
    runs-on: ubuntu-latest

    steps:
      - name: check lint results
        run: |
          echo "Zsh: ${{ needs.zsh.result }}"
          echo "Lua: ${{ needs.lua.result }}"
          echo "Python: ${{ needs.python.result }}"
          echo "TOML: ${{ needs.toml.result }}"
          echo "Markdown: ${{ needs.markdown.result }}"
          echo "YAML: ${{ needs.yaml.result }}"
          echo "JSON: ${{ needs.json.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"

          # Check for blocking failures
          if [[ "${{ needs.zsh.result }}" == "failure" ]] || \
             [[ "${{ needs.lua.result }}" == "failure" ]] || \
             [[ "${{ needs.python.result }}" == "failure" ]] || \
             [[ "${{ needs.json.result }}" == "failure" ]]; then
            echo "❌ Blocking lint checks failed"
            exit 1
          fi

          echo "✅ All blocking lint checks passed"
