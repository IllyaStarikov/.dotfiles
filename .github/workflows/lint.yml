name: Lint & Format

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: lint-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint All Code
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Setup Tools
        run: |
          # Install all linting tools
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck jq
          
          # Install stylua for Lua
          wget -qO stylua.zip https://github.com/JohnnyMorganz/StyLua/releases/download/v0.19.1/stylua-linux-x86_64.zip
          unzip -q stylua.zip && chmod +x stylua && sudo mv stylua /usr/local/bin/
          
          # Install Node tools
          npm install -g markdownlint-cli yaml-lint jsonlint --silent
      
      - name: Shell Scripts
        run: |
          echo "::group::ShellCheck"
          find . -type f -name "*.sh" -not -path "./.git/*" -print0 | xargs -0 shellcheck -x || true
          find src/scripts -type f -exec grep -l '^#!/.*sh' {} \; | xargs shellcheck -x || true
          echo "::endgroup::"
      
      - name: Lua Files
        run: |
          echo "::group::Stylua"
          find src -name "*.lua" -type f | xargs stylua --check --indent-type Spaces --indent-width 2 || true
          echo "::endgroup::"
      
      - name: Markdown Files
        run: |
          echo "::group::Markdownlint"
          markdownlint '**/*.md' --ignore node_modules --ignore .github || true
          echo "::endgroup::"
      
      - name: YAML Files
        run: |
          echo "::group::YAML Validation"
          find . -name "*.yml" -o -name "*.yaml" | grep -v node_modules | xargs -I {} sh -c 'echo "Checking: {}" && yaml-lint {} || true'
          echo "::endgroup::"
      
      - name: JSON Files
        run: |
          echo "::group::JSON Validation"
          find . -name "*.json" -type f -not -path "./.git/*" | while read -r file; do
            echo "Checking: $file"
            jq . "$file" > /dev/null || echo "Invalid JSON: $file"
          done
          echo "::endgroup::"
      
      - name: Code Quality Checks
        run: |
          echo "::group::Quality Checks"
          # Trailing whitespace
          ! grep -r '[[:space:]]$' src/ test/ --include="*.sh" --include="*.lua" --include="*.py" 2>/dev/null || echo "⚠️ Trailing whitespace found"
          
          # Tab/space consistency
          ! grep -r $'\t' src/ --include="*.lua" --include="*.yml" --include="*.yaml" --include="*.json" 2>/dev/null || echo "⚠️ Tabs in space-only files"
          
          # Line endings
          ! find src/ test/ -type f -exec file {} \; | grep CRLF || echo "⚠️ Windows line endings found"
          echo "::endgroup::"