#!/usr/bin/env zsh
# scratchpad - Create temporary files for quick editing
#
# DESCRIPTION:
#   Creates a unique temporary file and opens it in your preferred editor.
#   Useful for quick notes, code snippets, or temporary work.
#   Files persist in temp directory until system cleanup.
#
# USAGE:
#   scratchpad [extension]
#
#   scratchpad          # Create temp file with no extension
#   scratchpad py       # Create temp Python file (.py)
#   scratchpad md       # Create temp Markdown file (.md)
#   scratchpad json     # Create temp JSON file (.json)
#
# EDITOR:
#   Uses $EDITOR if set, otherwise vim (macOS) or nano (Linux)
#
# FILES:
#   Created in: $TMPDIR or /tmp
#   Naming: UUID-based or timestamp-PID-random for uniqueness
#
# Style Guide: https://google.github.io/styleguide/shellguide.html

# Source common library
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "${SCRIPT_DIR}/common.sh"

# Cleanup function to handle interrupts gracefully
cleanup() {
  # Nothing critical to clean up, but trap ensures clean exit
  exit 0
}

# Set up trap for clean exit on interrupt (Ctrl-C)
trap cleanup INT TERM

# Get file extension if provided
EXT="${1:+.$1}"

# Generate unique filename for temporary scratch file
# Uses uuidgen if available (standard on macOS and most Linux distros)
# Falls back to timestamp + process ID + random number for uniqueness
generate_filename() {
  if has_command uuidgen; then
    echo "$(uuidgen)"
  else
    # Fallback strategy: timestamp-processID-random ensures uniqueness
    # Format: scratch-YYYYMMDD-HHMMSS-PID-RANDOM
    echo "scratch-$(date +%Y%m%d-%H%M%S)-$$-$RANDOM"
  fi
}

# Create temp file path
TEMP_DIR="${TMPDIR:-${TMP:-/tmp}}"
FILENAME="$(generate_filename)${EXT}"
TEMP_FILE="${TEMP_DIR}/${FILENAME}"

# Select editor in order of preference:
# 1. User's $EDITOR environment variable (if set)
# 2. vim on macOS (pre-installed on all macOS versions)
# 3. nano on Linux (available on minimal installations)
EDITOR="${EDITOR:-$(platform_command 'vim' 'nano')}"

# Create and open the file
# The editor will create the file if it doesn't exist
print_color blue "Opening scratchpad: ${TEMP_FILE}"
"${EDITOR}" "${TEMP_FILE}"

# Check if file has content
if [[ -f "${TEMP_FILE}" ]] && [[ -s "${TEMP_FILE}" ]]; then
  print_color green "Scratchpad saved at: ${TEMP_FILE}"
else
  print_color yellow "Scratchpad was empty or not saved"
fi