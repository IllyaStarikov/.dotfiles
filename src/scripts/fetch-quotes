#!/usr/bin/env zsh
# Fetch inspirational quotes from multiple sources
# Works on both macOS and Linux

# Source common library
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "${SCRIPT_DIR}/common.sh"

# Configuration
QUOTES_COUNT=${1:-5}
TIMEOUT_DURATION=3

# Colors
CYAN='\033[0;36m'
NC='\033[0m'

# Check for required tools
check_requirements() {
  if ! has_command curl; then
    print_color red "Error: curl is required but not installed"
    exit 1
  fi
  
  if ! has_command jq; then
    print_color red "Error: jq is required but not installed"
    echo "Install with:"
    platform_command \
      "echo '  brew install jq'" \
      "echo '  sudo apt install jq  # Debian/Ubuntu'
       echo '  sudo dnf install jq  # Fedora'
       echo '  sudo pacman -S jq    # Arch'"
    exit 1
  fi
}

# Get timeout command
get_timeout_cmd() {
  if has_command timeout; then
    echo "timeout ${TIMEOUT_DURATION}"
  else
    # No timeout available, just use cat to pass through
    echo "cat"
  fi
}

# Fetch quotes from APIs
fetch_quotes() {
  local count=$1
  local fetched=0
  local timeout_cmd=$(get_timeout_cmd)
  
  # Try each API multiple times to ensure we get enough quotes
  while [ $fetched -lt $count ]; do
    # ZenQuotes
    if [ $fetched -lt $count ]; then
      local quote
      if [[ "$timeout_cmd" == "cat" ]]; then
        quote=$(curl -s 'https://zenquotes.io/api/random' 2>/dev/null | jq -r '.[0] | "💭 \"\(.q)\"\n   — \(.a)"' 2>/dev/null)
      else
        quote=$($timeout_cmd curl -s 'https://zenquotes.io/api/random' 2>/dev/null | jq -r '.[0] | "💭 \"\(.q)\"\n   — \(.a)"' 2>/dev/null)
      fi
      
      if [[ -n "$quote" ]] && [[ "$quote" != "null" ]]; then
        echo -e "$quote\n"
        ((fetched++))
      fi
    fi
    
    # Quotable
    if [ $fetched -lt $count ]; then
      local quote
      if [[ "$timeout_cmd" == "cat" ]]; then
        quote=$(curl -s 'https://api.quotable.io/random' 2>/dev/null | jq -r '"🌟 \"\(.content)\"\n   — \(.author)"' 2>/dev/null)
      else
        quote=$($timeout_cmd curl -s 'https://api.quotable.io/random' 2>/dev/null | jq -r '"🌟 \"\(.content)\"\n   — \(.author)"' 2>/dev/null)
      fi
      
      if [[ -n "$quote" ]] && [[ "$quote" != "null" ]]; then
        echo -e "$quote\n"
        ((fetched++))
      fi
    fi
    
    # Advice Slip
    if [ $fetched -lt $count ]; then
      local quote
      if [[ "$timeout_cmd" == "cat" ]]; then
        quote=$(curl -s 'https://api.adviceslip.com/advice' 2>/dev/null | jq -r '"💡 \(.slip.advice)"' 2>/dev/null)
      else
        quote=$($timeout_cmd curl -s 'https://api.adviceslip.com/advice' 2>/dev/null | jq -r '"💡 \(.slip.advice)"' 2>/dev/null)
      fi
      
      if [[ -n "$quote" ]] && [[ "$quote" != "null" ]]; then
        echo -e "$quote\n"
        ((fetched++))
      fi
    fi
    
    # If we still need more quotes, add a small delay before retrying
    if [ $fetched -lt $count ]; then
      sleep 0.5
    fi
  done
}

# Main execution
main() {
  check_requirements
  
  # Header
  echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════════${NC}"
  echo -e "${CYAN}                         ✨ Daily Inspiration ✨                               ${NC}"
  echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════════${NC}"
  echo ""
  
  # Fetch quotes
  fetch_quotes $QUOTES_COUNT
  
  echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════════${NC}"
}

main "$@"