#!/usr/bin/env zsh
# extract - Universal Archive Extractor
#
# DESCRIPTION:
#   Automatically detects and extracts various archive formats.
#   Eliminates need to remember different extraction commands.
#
# USAGE:
#   extract [-v|--verbose] <archive>
#
# OPTIONS:
#   -v, --verbose   Show files being extracted
#
# SUPPORTED FORMATS:
#   tar.bz2, tar.gz, tar.xz, bz2, rar, gz, tar, tbz2, tgz, zip, Z, 7z, xz
#
# Style Guide: https://google.github.io/styleguide/shellguide.html

VERBOSE=false

# Parse options
while [[ "$1" == -* ]]; do
    case "$1" in
        -v|--verbose) VERBOSE=true; shift ;;
        -h|--help)
            echo "Usage: extract [-v|--verbose] <archive>"
            echo "Supported formats: tar.bz2, tar.gz, tar.xz, bz2, rar, gz, tar, tbz2, tgz, zip, Z, 7z, xz"
            exit 0 ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
done

# Validate arguments
if [[ -z "$1" ]]; then
    echo "Usage: extract [-v|--verbose] <archive>"
    echo "Supported formats: tar.bz2, tar.gz, tar.xz, bz2, rar, gz, tar, tbz2, tgz, zip, Z, 7z, xz"
    exit 1
fi

# Check if file exists and is readable
if [[ ! -f "$1" ]]; then
    echo "Error: '$1' is not a valid file"
    exit 1
fi

# Set verbose flag for commands
TAR_VERBOSE=""
UNZIP_VERBOSE="-q"
if [[ "$VERBOSE" == true ]]; then
    TAR_VERBOSE="v"
    UNZIP_VERBOSE=""
fi

# Helper to format tar verbose output (replace 'x ' with '→ ')
format_tar_output() {
    if [[ "$VERBOSE" == true ]]; then
        sed 's/^x /→ /'
    else
        cat
    fi
}

# Extract based on file extension
# Uses most common extraction flags for each format
case "$1" in
    *.tar.bz2) tar x${TAR_VERBOSE}jf "$1" 2>&1 | format_tar_output ;;  # Bzip2 compressed tar
    *.tar.gz)  tar x${TAR_VERBOSE}zf "$1" 2>&1 | format_tar_output ;;  # Gzip compressed tar
    *.tar.xz)  tar x${TAR_VERBOSE}Jf "$1" 2>&1 | format_tar_output ;;  # XZ compressed tar
    *.bz2)
        if command -v bunzip2 &>/dev/null; then
            bunzip2 "$1"
        else
            echo "Error: bunzip2 not installed. Install bzip2 package."
            exit 1
        fi ;;                        # Bzip2 single file
    *.rar)
        if command -v unrar &>/dev/null; then
            unrar x "$1"
        else
            echo "Error: unrar not installed"
            echo "Install with:"
            echo "  macOS:  brew install unrar"
            echo "  Linux:  apt install unrar"
            exit 1
        fi ;;
    *.gz)
        if command -v gunzip &>/dev/null; then
            gunzip "$1"
        else
            echo "Error: gunzip not installed. Install gzip package."
            exit 1
        fi ;;                        # Gzip single file
    *.tar)     tar x${TAR_VERBOSE}f "$1" 2>&1 | format_tar_output ;;   # Uncompressed tar
    *.tbz2)    tar x${TAR_VERBOSE}jf "$1" 2>&1 | format_tar_output ;;  # Alternative bzip2 tar extension
    *.tgz)     tar x${TAR_VERBOSE}zf "$1" 2>&1 | format_tar_output ;;  # Alternative gzip tar extension
    *.zip)
        if command -v unzip &>/dev/null; then
            unzip $UNZIP_VERBOSE "$1"
        else
            echo "Error: unzip not installed. Install unzip package."
            exit 1
        fi ;;                        # ZIP archive
    *.Z)
        if command -v uncompress &>/dev/null; then
            uncompress "$1"
        else
            echo "Error: uncompress not installed. Install ncompress package."
            exit 1
        fi ;;                        # Unix compress format
    *.7z)
        if command -v 7z &>/dev/null; then
            7z x "$1"
        else
            echo "Error: 7z not installed"
            echo "Install with:"
            echo "  macOS:  brew install p7zip"
            echo "  Linux:  apt install p7zip-full"
            exit 1
        fi ;;
    *.xz)
        if command -v xz &>/dev/null; then
            xz -d "$1"
        else
            echo "Error: xz not installed. Install xz-utils package."
            exit 1
        fi ;;                        # XZ single file
    *)
        echo "Error: '$1' cannot be extracted via extract"
        echo "Unknown archive format"
        exit 1
        ;;
esac

# Report success
echo "✓ Extracted: $1"