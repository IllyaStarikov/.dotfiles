# ════════════════════════════════════════════════════════════════════════════════════════════════════════════
# 📚 LATEXMK CONFIGURATION - Production-Ready LaTeX Build System
# ════════════════════════════════════════════════════════════════════════════════════════════════════════════
# Optimized for:
# • Modern LaTeX workflow with LuaLaTeX
# • Automatic PDF preview with Skim (macOS)
# • SyncTeX support for forward/reverse search
# • Comprehensive cleanup of auxiliary files
# ════════════════════════════════════════════════════════════════════════════════════════════════════════════

# ────────────────────────────────────────────────────────────────────────────────────────────────────────────
# PDF GENERATION SETTINGS
# ────────────────────────────────────────────────────────────────────────────────────────────────────────────

# Use PDF mode (1 = pdflatex, 4 = lualatex, 5 = xelatex)
$pdf_mode = 4;  # LuaLaTeX for modern font support

# LuaLaTeX configuration
$lualatex = 'lualatex --interaction=nonstopmode --shell-escape --synctex=1 %O %S';

# Fallback to pdflatex if needed
$pdflatex = 'pdflatex --interaction=nonstopmode --shell-escape --synctex=1 %O %S';

# XeLaTeX configuration (alternative)
$xelatex = 'xelatex --interaction=nonstopmode --shell-escape --synctex=1 %O %S';

# ────────────────────────────────────────────────────────────────────────────────────────────────────────────
# PDF VIEWER CONFIGURATION
# ────────────────────────────────────────────────────────────────────────────────────────────────────────────

# Detect platform and set appropriate PDF viewer
if ($^O eq 'darwin') {
    # macOS: Use Skim for better LaTeX integration
    $pdf_previewer = 'open -a Skim %S';
} elsif ($^O eq 'linux') {
    # Linux - try different viewers in order of preference
    if (system("which zathura >/dev/null 2>&1") == 0) {
        $pdf_previewer = 'zathura %S';
    } elsif (system("which evince >/dev/null 2>&1") == 0) {
        $pdf_previewer = 'evince %S';
    } elsif (system("which okular >/dev/null 2>&1") == 0) {
        $pdf_previewer = 'okular %S';
    } else {
        $pdf_previewer = 'xdg-open %S';  # Default system viewer
    }
}

# Update PDF viewer after successful compilation
$pdf_update_method = 2;  # 2 = force update

# ────────────────────────────────────────────────────────────────────────────────────────────────────────────
# BUILD OPTIMIZATION
# ────────────────────────────────────────────────────────────────────────────────────────────────────────────

# Maximum number of iterations
$max_repeat = 5;

# Enable file recording for better dependency tracking
$recorder = 1;

# Bibtex/Biber configuration
$bibtex = 'bibtex %O %S';
$biber = 'biber --debug %O %S';

# Index generation
$makeindex = 'makeindex %O -o %D %S';

# Glossary generation (with glossaries package)
$makeglossaries = 'makeglossaries %O %S';

# ────────────────────────────────────────────────────────────────────────────────────────────────────────────
# CLEANUP CONFIGURATION
# ────────────────────────────────────────────────────────────────────────────────────────────────────────────

# Comprehensive list of generated files to clean
@generated_exts = qw(
    aux idx ind fls lof lot out toc
    acn acr alg glg glo gls ist
    nav vrb snm
    bbl bcf blg run.xml
    fdb_latexmk synctex.gz
    log
);

# Additional cleanup patterns
$clean_ext = 'synctex.gz synctex.gz(busy) run.xml tex.bak bbl bcf fdb_latexmk';

# ────────────────────────────────────────────────────────────────────────────────────────────────────────────
# CUSTOM BUILD COMMANDS
# ────────────────────────────────────────────────────────────────────────────────────────────────────────────

# Quick build command (draft mode)
# latexmk -pdflatex="pdflatex --interaction=nonstopmode --draftmode" -pdf

# Continuous preview mode
# latexmk -pvc -pdf

# Clean all auxiliary files
# latexmk -c

# Clean all files including PDF
# latexmk -C
